{
  "name": "WF1 ‚Äî Post Generation (FIXED)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "trigger",
      "name": "Daily 8AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        100,
        300
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_PROJECTS_DB_ID",
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Active",
              "condition": "equals",
              "value": true
            }
          ]
        }
      },
      "id": "get-projects",
      "name": "Get Active Projects",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        300,
        200
      ],
      "credentials": {
        "notionApi": {
          "id": "YOUR_NOTION_CREDENTIAL_ID",
          "name": "Notion API"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_TRENDS_DB_ID",
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Date",
              "condition": "equals",
              "value": "={{ $now.format('yyyy-MM-dd') }}"
            }
          ]
        }
      },
      "id": "get-trends",
      "name": "Get Today Trends",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        300,
        400
      ],
      "credentials": {
        "notionApi": {
          "id": "YOUR_NOTION_CREDENTIAL_ID",
          "name": "Notion API"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "id": "merge",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const projects = $('Get Active Projects').all();\nconst trendsItems = $('Get Today Trends').all();\nconst trendsData = trendsItems[0]?.json?.properties || {};\n\n// Knowledge Base ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∏–Ω—Å–∞–π—Ç–æ–≤ (Applied = true)\nconst kbItems = $('Get Knowledge Base').all();\nconst globalInsights = kbItems\n  .map(k => k.json.properties?.Content?.rich_text?.[0]?.plain_text || '')\n  .filter(Boolean)\n  .slice(0, 10);\n\nconst result = [];\n\nfor (const proj of projects) {\n  const props = proj.json.properties || {};\n  const projectName = props.Name?.title?.[0]?.plain_text || 'Unknown';\n  const projectId = props.ID?.rich_text?.[0]?.plain_text || projectName.toLowerCase().replace(/ /g, '_');\n  const niche = props.Niche?.select?.name || '';\n  const tone = props.Tone?.select?.name || 'professional';\n  const language = props.Language?.select?.name || 'ru';\n  const audience = props.Audience?.rich_text?.[0]?.plain_text || '';\n  const systemPrompt = props['System Prompt']?.rich_text?.[0]?.plain_text || '';\n  const platforms = props.Platforms?.multi_select?.map(p => p.name.toLowerCase()) || ['instagram', 'telegram'];\n\n  // –¢—Ä–µ–Ω–¥ –∏ –∏–¥–µ—è –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞\n  const trendKey = projectId === 'personal_brand' ? 'Personal Brand Trend'\n    : projectId === 'leader_team' ? 'Leader Team Trend' : 'Pixie Trend';\n  const ideaKey = projectId === 'personal_brand' ? 'Personal Brand Idea'\n    : projectId === 'leader_team' ? 'Leader Team Idea' : 'Pixie Idea';\n  const trend = trendsData[trendKey]?.rich_text?.[0]?.plain_text || '';\n  const idea = trendsData[ideaKey]?.rich_text?.[0]?.plain_text || '';\n\n  // –ò–Ω—Å–∞–π—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ Knowledge Base\n  const projectInsights = kbItems\n    .filter(k => {\n      const kbProj = k.json.properties?.Project?.select?.name || '';\n      return kbProj === projectName || kbProj === '';\n    })\n    .map(k => {\n      const p = k.json.properties || {};\n      const type = p.Type?.select?.name || '';\n      const content = p.Content?.rich_text?.[0]?.plain_text || '';\n      const metric = p.Metric?.number;\n      return metric ? `[${type}] ${content} (ER: ${metric}%)` : `[${type}] ${content}`;\n    })\n    .filter(Boolean)\n    .slice(0, 8);\n\n  for (const platform of platforms) {\n    result.push({\n      json: {\n        projectId, projectName, niche, tone, language, audience,\n        systemPrompt, platform, trend, idea,\n        insights: projectInsights.length > 0 ? projectInsights : globalInsights.slice(0, 5)\n      }\n    });\n  }\n}\n\nreturn result;"
      },
      "id": "split-tasks",
      "name": "Split into Tasks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "YOUR_ANTHROPIC_API_KEY"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-6\",\n  \"max_tokens\": 1200,\n  \"system\": \"{{ $json.systemPrompt || '–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç.' }}\\n\\n–ì–õ–ê–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:\\n1. –ö–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ ‚Äî –ª—É—á—à–µ –æ–¥–∏–Ω —Å–∏–ª—å–Ω—ã–π –ø–æ—Å—Ç —á–µ–º —Å–ª–∞–±—ã–π\\n2. –°—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π –≥–æ–ª–æ—Å –±—Ä–µ–Ω–¥–∞ ‚Äî –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º —Å–ø—Ä–æ—Å–∏ —Å–µ–±—è: —ç—Ç–æ –º–æ–≥ –±—ã —Å–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –±—Ä–µ–Ω–¥?\\n3. –£—á–∏—Å—å –Ω–∞ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –ø—Ä–∏–º–µ–Ω—è–π\\n4. –§–∏–ª—å—Ç—Ä—É–π —Ç—Ä–µ–Ω–¥—ã ‚Äî –µ—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏—à–µ, –∏—Å–ø–æ–ª—å–∑—É–π –≤–µ—á–Ω–æ–∑–µ–ª—ë–Ω—É—é —Ç–µ–º—É\\n5. –ß–µ—Ä–µ–¥—É–π —Ñ–æ—Ä–º–∞—Ç—ã ‚Äî –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç 2 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥\",\n  \"messages\": [{\n    \"role\": \"user\",\n    \"content\": \"–°–æ–∑–¥–∞–π –ø–æ—Å—Ç –¥–ª—è {{ $json.platform }}.\\n\\n–ü–†–û–ï–ö–¢: {{ $json.projectName }}\\n–ù–ò–®–ê: {{ $json.niche }}\\n–¢–û–ù: {{ $json.tone }}\\n–Ø–ó–´–ö: {{ $json.language }}\\n–ê–£–î–ò–¢–û–†–ò–Ø: {{ $json.audience }}\\n\\n–¢–†–ï–ù–î –î–ù–Ø: {{ $json.trend || '–Ω–µ—Ç —Ç—Ä–µ–Ω–¥–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –≤–µ—á–Ω–æ–∑–µ–ª—ë–Ω—É—é —Ç–µ–º—É' }}\\n–ò–î–ï–Ø: {{ $json.idea || '' }}\\n\\n–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (—á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞–Ω—å—à–µ):\\n{{ $json.insights && $json.insights.length > 0 ? $json.insights.join('\\\\n') : '–±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ–∫–∞ –ø—É—Å—Ç–∞ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫' }}\\n\\n–ê–õ–ì–û–†–ò–¢–ú (–≤—ã–ø–æ–ª–Ω–∏ –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º):\\n1. –ü—Ä–æ–≤–µ—Ä—å —Ç—Ä–µ–Ω–¥: —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –ª–∏ –æ–Ω –Ω–∏—à–µ '{{ $json.niche }}' –∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ '{{ $json.audience }}'?\\n   –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–∑ –Ω–∏—à–∏\\n2. –ü—Ä–æ—á–∏—Ç–∞–π –±–∞–∑—É –∑–Ω–∞–Ω–∏–π: –∫–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–≤–∞–ª –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?\\n   –í—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç –∫–æ—Ç–æ—Ä—ã–π –ù–ï –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π\\n   –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: –∫–µ–π—Å | –∏–Ω—Å–∞–π—Ç/–º–Ω–µ–Ω–∏–µ | –æ–±—É—á–µ–Ω–∏–µ/—Å–æ–≤–µ—Ç—ã | –∏—Å—Ç–æ—Ä–∏—è | –¥–∞–Ω–Ω—ã–µ+–∞–Ω–∞–ª–∏–∑ | –≤–æ–ø—Ä–æ—Å –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏\\n3. –ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç —Å—Ç—Ä–æ–≥–æ –≤ –≥–æ–ª–æ—Å–µ –±—Ä–µ–Ω–¥–∞\\n4. –ü—Ä–æ–≤–µ—Ä—å: '–≠—Ç–æ —Ç–æ—á–Ω–æ {{ $json.projectName }} –≥–æ–≤–æ—Ä–∏—Ç?' ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç, –ø–µ—Ä–µ–ø–∏—à–∏\\n\\n–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û –ü–õ–ê–¢–§–û–†–ú–ï:\\n- instagram: –∫—Ä—é—á–æ–∫ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ (max 8 —Å–ª–æ–≤) + 150-300 —Å–ª–æ–≤ + 10-15 —Ö—ç—à—Ç–µ–≥–æ–≤ + CTA\\n- telegram: —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π + —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ + 100-250 —Å–ª–æ–≤ + –±–µ–∑ —Ö—ç—à—Ç–µ–≥–æ–≤\\n- facebook: –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–π –≤–æ–ø—Ä–æ—Å + 200-400 —Å–ª–æ–≤ + 3-5 —Ö—ç—à—Ç–µ–≥–æ–≤ + –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ü–µ\\n- linkedin: —Å–∏–ª—å–Ω—ã–π —Ç–µ–∑–∏—Å + –∏–Ω—Å–∞–π—Ç –∏–ª–∏ –∫–µ–π—Å + 150-300 —Å–ª–æ–≤ + 3-5 —Ö—ç—à—Ç–µ–≥–æ–≤\\n\\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.\"\n  }]\n}",
        "options": {}
      },
      "id": "claude-api",
      "name": "Claude API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\n// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ Anthropic API response\nconst text = response.content?.[0]?.text || response.error?.message || 'Error generating post';\nconst prev = $('Split into Tasks').item.json;\n\nreturn [{ json: { ...prev, generatedText: text } }];"
      },
      "id": "extract-text",
      "name": "Extract Generated Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        300
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "YOUR_NOTION_CONTENT_CALENDAR_DB_ID",
        "title": "={{ $json.projectName }} | {{ $json.platform }} | {{ $now.format('dd.MM.yyyy') }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Project",
              "type": "select",
              "selectValue": "={{ $json.projectName }}"
            },
            {
              "key": "Platform",
              "type": "select",
              "selectValue": "={{ $json.platform }}"
            },
            {
              "key": "Content",
              "type": "rich_text",
              "textValue": "={{ $json.generatedText }}"
            },
            {
              "key": "Status",
              "type": "select",
              "selectValue": "Draft"
            },
            {
              "key": "Category",
              "type": "select",
              "selectValue": "–¢—Ä–µ–Ω–¥"
            },
            {
              "key": "Scheduled Date",
              "type": "date",
              "dateValue": "={{ $now.plus(1, 'day').format('yyyy-MM-dd') }}"
            },
            {
              "key": "Created By",
              "type": "select",
              "selectValue": "Agent"
            }
          ]
        }
      },
      "id": "save-to-notion",
      "name": "Save to Content Calendar",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        1300,
        300
      ],
      "credentials": {
        "notionApi": {
          "id": "YOUR_NOTION_CREDENTIAL_ID",
          "name": "Notion API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ—Å—Ç—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\nconst items = $input.all();\nconst byProject = {};\nfor (const item of items) {\n  const p = item.json.projectName;\n  if (!byProject[p]) byProject[p] = [];\n  byProject[p].push(item.json.platform);\n}\nconst summary = Object.entries(byProject)\n  .map(([proj, platforms]) => `üìÅ ${proj}: ${platforms.join(', ')}`)\n  .join('\\n');\n\nreturn [{ json: { summary, total: items.length } }];"
      },
      "id": "summarize",
      "name": "Summarize Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "=‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! {{ $json.total }} –ø–æ—Å—Ç–æ–≤ –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ.\n\n{{ $json.summary }}\n\nüëâ –û–¥–æ–±—Ä–∏ –≤ Notion: https://notion.so/YOUR_CONTENT_CALENDAR_PAGE",
        "additionalFields": {}
      },
      "id": "notify",
      "name": "Notify ‚Äî Done",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1700,
        300
      ],
      "credentials": {
        "telegramApi": {
          "id": "YOUR_TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_KNOWLEDGE_BASE_DB_ID",
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Applied",
              "condition": "equals",
              "value": true
            }
          ]
        },
        "limit": 10
      },
      "id": "get-kb",
      "name": "Get Knowledge Base",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        300,
        400
      ],
      "credentials": {
        "notionApi": {
          "id": "YOUR_NOTION_CREDENTIAL_ID",
          "name": "Notion API"
        }
      }
    }
  ],
  "connections": {
    "Daily 8AM": {
      "main": [
        [
          {
            "node": "Get Active Projects",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Today Trends",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Knowledge Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Projects": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Today Trends": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Split into Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split into Tasks": {
      "main": [
        [
          {
            "node": "Claude API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude API": {
      "main": [
        [
          {
            "node": "Extract Generated Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Generated Text": {
      "main": [
        [
          {
            "node": "Save to Content Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Content Calendar": {
      "main": [
        [
          {
            "node": "Summarize Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize Results": {
      "main": [
        [
          {
            "node": "Notify ‚Äî Done",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Knowledge Base": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}