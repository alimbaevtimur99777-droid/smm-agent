{
  "name": "WF3 ‚Äî Telegram Bot (FIXED)",
  "nodes": [
    {
      "parameters": { "updates": ["message"] },
      "id": "tg-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [100, 300],
      "webhookId": "smm-bot-v3",
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    },
    {
      "parameters": {
        "jsCode": "// SECURITY: —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–≤–æ–π chat_id\nconst ALLOWED = 123456789; // ‚Üê –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π —á–∏—Å–ª–æ–≤–æ–π chat_id\n\nconst msg = $input.first().json.message || {};\nconst chatId = msg.chat?.id;\nconst text = (msg.text || '').trim();\n\nif (chatId !== ALLOWED) {\n  return [{ json: { blocked: true, chatId } }];\n}\n\nconst parts = text.split(' ');\nconst command = parts[0]?.toLowerCase() || '';\nconst argsRaw = parts.slice(1).join(' ');\nconst args = argsRaw.toLowerCase();\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç\nconst projectMap = [\n  ['–ª–∏—á–Ω—ã–π', 'personal_brand', '–õ–∏—á–Ω—ã–π –ë—Ä–µ–Ω–¥'],\n  ['–ª–∏–¥–µ—Ä', 'leader_team', '–õ–∏–¥–µ—Ä –¢–∏–º'],\n  ['–ø–∏–∫—Å–∏', 'pixie', '–ü–∏–∫—Å–∏']\n];\nlet projectId = null, projectName = null;\nfor (const [key, id, name] of projectMap) {\n  if (args.includes(key)) { projectId = id; projectName = name; break; }\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É\nconst platformMap = [\n  ['–∏–Ω—Å—Ç–∞', 'instagram'], ['instagram', 'instagram'],\n  ['—Ç–≥', 'telegram'], ['telegram', 'telegram'],\n  ['—Ñ–±', 'facebook'], ['facebook', 'facebook'],\n  ['–ª–∏–Ω', 'linkedin'], ['linkedin', 'linkedin']\n];\nlet platform = null;\nfor (const [key, val] of platformMap) {\n  if (args.includes(key)) { platform = val; break; }\n}\n\nreturn [{ json: { blocked: false, command, chatId, projectId, projectName, platform, argsRaw } }];"
      },
      "id": "guard",
      "name": "Security Guard + Parse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 300]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [{ "leftValue": "={{ $json.blocked }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }]
        }
      },
      "id": "check-blocked",
      "name": "Blocked?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            { "conditions": { "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "/generate", "operator": { "type": "string", "operation": "equals" } }] }, "renameOutput": true, "outputKey": "generate" },
            { "conditions": { "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "/trends", "operator": { "type": "string", "operation": "equals" } }] }, "renameOutput": true, "outputKey": "trends" },
            { "conditions": { "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "/status", "operator": { "type": "string", "operation": "equals" } }] }, "renameOutput": true, "outputKey": "status" },
            { "conditions": { "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "/report", "operator": { "type": "string", "operation": "equals" } }] }, "renameOutput": true, "outputKey": "report" },
            { "conditions": { "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "/help", "operator": { "type": "string", "operation": "equals" } }] }, "renameOutput": true, "outputKey": "help" }
          ]
        }
      },
      "id": "router",
      "name": "Route Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [700, 200]
    },

    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_KNOWLEDGE_BASE_DB_ID",
        "filterType": "manual",
        "filters": { "conditions": [{ "key": "Applied", "condition": "equals", "value": true }] },
        "limit": 5
      },
      "id": "get-kb",
      "name": "Get Knowledge Base",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [900, 80],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "jsCode": "const kbItems = $('Get Knowledge Base').all();\nconst cmd = $('Route Command').item.json;\n\nconst insights = kbItems\n  .map(k => k.json.properties?.Content?.rich_text?.[0]?.plain_text || '')\n  .filter(Boolean)\n  .slice(0, 5);\n\nreturn [{ json: { ...cmd, insights } }];"
      },
      "id": "combine-kb",
      "name": "Combine KB with Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 80]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "YOUR_ANTHROPIC_API_KEY" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-6\",\n  \"max_tokens\": 1200,\n  \"system\": \"–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –°—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π –≥–æ–ª–æ—Å –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.\",\n  \"messages\": [{\n    \"role\": \"user\",\n    \"content\": \"–°–æ–∑–¥–∞–π –ø–æ—Å—Ç.\\n\\n–ü–†–û–ï–ö–¢: {{ $json.projectName }}\\n–ü–õ–ê–¢–§–û–†–ú–ê: {{ $json.platform }}\\n\\n–ü—Ä–æ–µ–∫—Ç—ã:\\n- –õ–∏—á–Ω—ã–π –ë—Ä–µ–Ω–¥: –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-—ç–∫—Å–ø–µ—Ä—Ç, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, —Ä—É—Å/—É–∑–±, –¶–ê: –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–∏\\n- –õ–∏–¥–µ—Ä –¢–∏–º: B2B —Ç–µ–ª–µ–∫–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –¥–µ–ª–æ–≤–æ–π, —Ä—É—Å, –¶–ê: IT-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞\\n- –ü–∏–∫—Å–∏: –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ç–µ–ª–µ–∫–æ–º, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π, —Ä—É—Å, –¶–ê: –∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä—ã\\n\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã:\\n- instagram: –∫—Ä—é—á–æ–∫ + 150-300 —Å–ª–æ–≤ + 10-15 —Ö—ç—à—Ç–µ–≥–æ–≤ + CTA\\n- telegram: —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π + 100-250 —Å–ª–æ–≤ + –±–µ–∑ —Ö—ç—à—Ç–µ–≥–æ–≤\\n- facebook: –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π + 200-400 —Å–ª–æ–≤ + 3-5 —Ö—ç—à—Ç–µ–≥–æ–≤ + –≤–æ–ø—Ä–æ—Å\\n- linkedin: –¥–µ–ª–æ–≤–æ–π + –∏–Ω—Å–∞–π—Ç/–∫–µ–π—Å + 150-300 —Å–ª–æ–≤ + 3-5 —Ö—ç—à—Ç–µ–≥–æ–≤\\n\\n–ß–¢–û –†–ê–ë–û–¢–ê–õ–û –•–û–†–û–®–û –†–ê–ù–¨–®–ï:\\n{{ $json.insights.length > 0 ? $json.insights.join('\\\\n') : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}\\n\\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.\"\n  }]\n}",
        "options": {}
      },
      "id": "claude-gen",
      "name": "Claude ‚Äî Generate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 80]
    },
    {
      "parameters": {
        "chatId": "={{ $('Security Guard + Parse').item.json.chatId }}",
        "text": "=üìù {{ $('Combine KB with Command').item.json.projectName }} / {{ $('Combine KB with Command').item.json.platform }}\n\n{{ $json.content?.[0]?.text || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏' }}",
        "additionalFields": {}
      },
      "id": "send-gen",
      "name": "Send Generated Post",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1500, 80],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    },

    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_TRENDS_DB_ID",
        "filterType": "manual",
        "filters": { "conditions": [{ "key": "Date", "condition": "equals", "value": "={{ $now.format('yyyy-MM-dd') }}" }] },
        "limit": 1
      },
      "id": "get-trends-today",
      "name": "Get Today Trends",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [900, 240],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst chatId = $('Security Guard + Parse').item.json.chatId;\n\nif (!items || items.length === 0) {\n  return [{ json: { chatId, text: 'üì≠ –¢—Ä–µ–Ω–¥—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ó–∞–ø—É—Å–∫–∞—é –≤ 07:00.' } }];\n}\n\nconst props = items[0].json.properties || {};\nconst pb_t = props['Personal Brand Trend']?.rich_text?.[0]?.plain_text || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';\nconst pb_i = props['Personal Brand Idea']?.rich_text?.[0]?.plain_text || '';\nconst lt_t = props['Leader Team Trend']?.rich_text?.[0]?.plain_text || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';\nconst lt_i = props['Leader Team Idea']?.rich_text?.[0]?.plain_text || '';\nconst px_t = props['Pixie Trend']?.rich_text?.[0]?.plain_text || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';\nconst px_i = props['Pixie Idea']?.rich_text?.[0]?.plain_text || '';\nconst date = props['Date']?.date?.start || '—Å–µ–≥–æ–¥–Ω—è';\n\nconst text = `üî• –¢—Ä–µ–Ω–¥—ã ${date}\\n\\nüë§ –õ–ò–ß–ù–´–ô –ë–†–ï–ù–î\\nüìå ${pb_t}\\nüí° ${pb_i}\\n\\nüè¢ –õ–ò–î–ï–† –¢–ò–ú\\nüìå ${lt_t}\\nüí° ${lt_i}\\n\\n‚ö° –ü–ò–ö–°–ò\\nüìå ${px_t}\\nüí° ${px_i}`;\n\nreturn [{ json: { chatId, text } }];"
      },
      "id": "format-trends",
      "name": "Format Trends",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 240]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.text }}",
        "additionalFields": {}
      },
      "id": "send-trends",
      "name": "Send Trends",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1300, 240],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    },

    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_CONTENT_CALENDAR_DB_ID",
        "filterType": "manual",
        "filters": { "conditions": [{ "key": "Status", "condition": "equals", "value": "Draft" }] }
      },
      "id": "get-drafts",
      "name": "Get Drafts",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [900, 400],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "jsCode": "const drafts = $input.all();\nconst chatId = $('Security Guard + Parse').item.json.chatId;\n\nconst byProject = {};\nfor (const d of drafts) {\n  const props = d.json.properties || {};\n  const proj = props.Project?.select?.name || 'Unknown';\n  const plat = props.Platform?.select?.name || '';\n  if (!byProject[proj]) byProject[proj] = [];\n  byProject[proj].push(plat);\n}\n\nconst lines = Object.entries(byProject)\n  .map(([p, pl]) => `üìÅ ${p}: ${pl.join(', ')} (${pl.length})`)\n  .join('\\n');\n\nconst text = `üìä –°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞\\n‚úÖ –ê–∫—Ç–∏–≤–µ–Ω\\nüïê ${new Date().toLocaleString('ru-RU', {timeZone: 'Asia/Tashkent'})}\\n\\nüìã –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ (Draft): ${drafts.length}\\n${lines || '–ù–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤'}\\n\\n–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:\\n‚Ä¢ 06:00 ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã\\n‚Ä¢ 07:00 ‚Äî —Ç—Ä–µ–Ω–¥—ã\\n‚Ä¢ 08:00 ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤\\n‚Ä¢ 10/14/18 ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è\\n‚Ä¢ –ø–Ω 09:00 ‚Äî –æ—Ç—á—ë—Ç`;\n\nreturn [{ json: { chatId, text } }];"
      },
      "id": "format-status",
      "name": "Format Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 400]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.text }}",
        "additionalFields": {}
      },
      "id": "send-status",
      "name": "Send Status",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1300, 400],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    },

    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_REPORTS_DB_ID",
        "filterType": "manual",
        "limit": 1
      },
      "id": "get-last-report",
      "name": "Get Last Report",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [900, 560],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "jsCode": "const reports = $input.all();\nconst chatId = $('Security Guard + Parse').item.json.chatId;\n\nif (!reports || reports.length === 0) {\n  return [{ json: { chatId, text: 'üì≠ –û—Ç—á—ë—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ü–µ—Ä–≤—ã–π –ø—Ä–∏–¥—ë—Ç –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 09:00.' } }];\n}\n\nconst props = reports[0].json.properties || {};\nconst insights = props.Insights?.rich_text?.[0]?.plain_text || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';\nconst week = props.Week?.date?.start || '';\n\nconst text = `üìà –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á—ë—Ç (${week}):\\n\\n${insights.slice(0, 3000)}`;\nreturn [{ json: { chatId, text } }];"
      },
      "id": "format-report",
      "name": "Format Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 560]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.text }}",
        "additionalFields": {}
      },
      "id": "send-report",
      "name": "Send Report",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1300, 560],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    },

    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "ü§ñ SMM –ê–≥–µ–Ω—Ç ‚Äî –ö–æ–º–∞–Ω–¥—ã:\n\nüìù /generate [–ø—Ä–æ–µ–∫—Ç] [–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞]\n–ü—Ä–∏–º–µ—Ä: /generate –ª–∏–¥–µ—Ä –∏–Ω—Å—Ç–∞\n\nüî• /trends ‚Äî —Ç—Ä–µ–Ω–¥—ã –¥–Ω—è\n\nüìä /status ‚Äî —Å—Ç–∞—Ç—É—Å –∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∏\n\nüìà /report ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á—ë—Ç\n\n‚ùì /help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n–ü—Ä–æ–µ–∫—Ç—ã: –ª–∏—á–Ω—ã–π | –ª–∏–¥–µ—Ä | –ø–∏–∫—Å–∏\n–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã: –∏–Ω—Å—Ç–∞ | —Ç–≥ | —Ñ–± | –ª–∏–Ω",
        "additionalFields": {}
      },
      "id": "send-help",
      "name": "Send Help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [900, 720],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    }
  ],
  "connections": {
    "Telegram Trigger": { "main": [[{ "node": "Security Guard + Parse", "type": "main", "index": 0 }]] },
    "Security Guard + Parse": { "main": [[{ "node": "Blocked?", "type": "main", "index": 0 }]] },
    "Blocked?": { "false": [[{ "node": "Route Command", "type": "main", "index": 0 }]] },
    "Route Command": {
      "generate": [[{ "node": "Get Knowledge Base", "type": "main", "index": 0 }]],
      "trends": [[{ "node": "Get Today Trends", "type": "main", "index": 0 }]],
      "status": [[{ "node": "Get Drafts", "type": "main", "index": 0 }]],
      "report": [[{ "node": "Get Last Report", "type": "main", "index": 0 }]],
      "help": [[{ "node": "Send Help", "type": "main", "index": 0 }]]
    },
    "Get Knowledge Base": { "main": [[{ "node": "Combine KB with Command", "type": "main", "index": 0 }]] },
    "Combine KB with Command": { "main": [[{ "node": "Claude ‚Äî Generate", "type": "main", "index": 0 }]] },
    "Claude ‚Äî Generate": { "main": [[{ "node": "Send Generated Post", "type": "main", "index": 0 }]] },
    "Get Today Trends": { "main": [[{ "node": "Format Trends", "type": "main", "index": 0 }]] },
    "Format Trends": { "main": [[{ "node": "Send Trends", "type": "main", "index": 0 }]] },
    "Get Drafts": { "main": [[{ "node": "Format Status", "type": "main", "index": 0 }]] },
    "Format Status": { "main": [[{ "node": "Send Status", "type": "main", "index": 0 }]] },
    "Get Last Report": { "main": [[{ "node": "Format Report", "type": "main", "index": 0 }]] },
    "Format Report": { "main": [[{ "node": "Send Report", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" }
}
