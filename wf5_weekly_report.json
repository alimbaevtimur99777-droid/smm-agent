{
  "name": "WF5 ‚Äî Weekly Report (FIXED)",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "cronExpression", "expression": "0 9 * * 1" }] }
      },
      "id": "trigger",
      "name": "Every Monday 9AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [100, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_CONTENT_CALENDAR_DB_ID",
        "filterType": "manual",
        "filters": {
          "conditions": [
            { "key": "Status", "condition": "equals", "value": "Published" },
            { "key": "Scheduled Date", "condition": "after", "value": "={{ $now.minus(7, 'day').format('yyyy-MM-dd') }}" }
          ]
        }
      },
      "id": "get-posts",
      "name": "Get Last Week Posts",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [300, 200],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "YOUR_NOTION_KNOWLEDGE_BASE_DB_ID",
        "filterType": "manual",
        "filters": { "conditions": [{ "key": "Type", "condition": "equals", "value": "–õ—É—á—à–∏–π –ø–æ—Å—Ç" }] },
        "limit": 5
      },
      "id": "get-kb",
      "name": "Get Knowledge Base",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [300, 400],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "id": "merge",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [500, 300]
    },
    {
      "parameters": {
        "jsCode": "// –ß–∏—Ç–∞–µ–º –æ–±–µ –Ω–æ–¥—ãx –Ω–∞–ø—Ä—è–º—É—é\nconst posts = $('Get Last Week Posts').all();\nconst kb = $('Get Knowledge Base').all();\n\nconst weekStart = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];\nconst weekEnd = new Date().toISOString().split('T')[0];\n\n// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ—Å—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º\nconst byProject = {};\nfor (const item of posts) {\n  const props = item.json.properties || {};\n  const project = props.Project?.select?.name || 'Unknown';\n  const platform = props.Platform?.select?.name || '';\n  const engagement = props.Engagement?.number || 0;\n  const reach = props.Reach?.number || 0;\n  const content = props.Content?.rich_text?.[0]?.plain_text?.slice(0, 150) || '';\n\n  if (!byProject[project]) byProject[project] = { posts: [], totalReach: 0, totalEngagement: 0, count: 0 };\n  byProject[project].posts.push({ platform, engagement, reach, content });\n  byProject[project].totalReach += reach;\n  byProject[project].totalEngagement += engagement;\n  byProject[project].count++;\n}\n\n// ER –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º\nfor (const [proj, data] of Object.entries(byProject)) {\n  data.avgER = data.totalReach > 0 ? ((data.totalEngagement / data.totalReach) * 100).toFixed(1) : '0';\n}\n\n// –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π\nconst insights = kb.map(k => k.json.properties?.Content?.rich_text?.[0]?.plain_text || '').filter(Boolean);\n\nreturn [{ json: { byProject, insights, weekStart, weekEnd, totalPosts: posts.length } }];"
      },
      "id": "aggregate",
      "name": "Aggregate Stats",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "YOUR_ANTHROPIC_API_KEY" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-6\",\n  \"max_tokens\": 1800,\n  \"system\": \"–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ SMM. –ü–∏—à–∏ –æ—Ç—á—ë—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –≤–æ–¥—ã. –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è.\",\n  \"messages\": [{\n    \"role\": \"user\",\n    \"content\": \"–°–æ–∑–¥–∞–π –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π SMM –æ—Ç—á—ë—Ç.\\n\\n–ü–µ—Ä–∏–æ–¥: {{ $json.weekStart }} ‚Äî {{ $json.weekEnd }}\\n–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤: {{ $json.totalPosts }}\\n\\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\\n{{ JSON.stringify($json.byProject, null, 2) }}\\n\\n–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (—á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞–Ω—å—à–µ):\\n{{ $json.insights.join('\\\\n') || '–ø—É—Å—Ç–æ' }}\\n\\n–§–æ—Ä–º–∞—Ç –æ—Ç—á—ë—Ç–∞:\\nüìä –û–¢–ß–Å–¢ {{ $json.weekStart }} ‚Äî {{ $json.weekEnd }}\\n\\n–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:\\n[–ù–∞–∑–≤–∞–Ω–∏–µ]\\n‚Ä¢ –ü–æ—Å—Ç–æ–≤: X\\n‚Ä¢ –û—Ö–≤–∞—Ç: X\\n‚Ä¢ ER: X%\\n‚Ä¢ –õ—É—á—à–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞: X\\n‚Ä¢ –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ: [1 –∏–Ω—Å–∞–π—Ç]\\n‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]\\n\\nüéØ –ò–¢–û–ì–ò –ù–ï–î–ï–õ–ò:\\n‚Ä¢ –¢–æ–ø-3 –≤—ã–≤–æ–¥–∞\\n‚Ä¢ –§–æ–∫—É—Å —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏\\n\\n–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ.\"\n  }]\n}",
        "options": {}
      },
      "id": "claude-report",
      "name": "Claude ‚Äî Generate Report",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst reportText = response.content?.[0]?.text || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞';\nconst agg = $('Aggregate Stats').item.json;\n\nreturn [{ json: { reportText, weekStart: agg.weekStart, weekEnd: agg.weekEnd } }];"
      },
      "id": "extract-report",
      "name": "Extract Report Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "YOUR_NOTION_REPORTS_DB_ID",
        "title": "=–û—Ç—á—ë—Ç {{ $json.weekStart }} ‚Äî {{ $json.weekEnd }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "Week", "type": "date", "dateValue": "={{ $json.weekStart }}" },
            { "key": "Insights", "type": "rich_text", "textValue": "={{ $json.reportText }}" }
          ]
        }
      },
      "id": "save-report",
      "name": "Save to Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1300, 300],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "={{ $('Extract Report Text').item.json.reportText.slice(0, 4000) }}",
        "additionalFields": {}
      },
      "id": "send-report",
      "name": "Send Report",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1500, 300],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    }
  ],
  "connections": {
    "Every Monday 9AM": {
      "main": [[
        { "node": "Get Last Week Posts", "type": "main", "index": 0 },
        { "node": "Get Knowledge Base", "type": "main", "index": 0 }
      ]]
    },
    "Get Last Week Posts": { "main": [[{ "node": "Merge", "type": "main", "index": 0 }]] },
    "Get Knowledge Base": { "main": [[{ "node": "Merge", "type": "main", "index": 1 }]] },
    "Merge": { "main": [[{ "node": "Aggregate Stats", "type": "main", "index": 0 }]] },
    "Aggregate Stats": { "main": [[{ "node": "Claude ‚Äî Generate Report", "type": "main", "index": 0 }]] },
    "Claude ‚Äî Generate Report": { "main": [[{ "node": "Extract Report Text", "type": "main", "index": 0 }]] },
    "Extract Report Text": { "main": [[{ "node": "Save to Notion", "type": "main", "index": 0 }]] },
    "Save to Notion": { "main": [[{ "node": "Send Report", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" }
}
