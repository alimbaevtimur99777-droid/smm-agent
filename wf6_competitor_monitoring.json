{
  "name": "WF6 ‚Äî Competitor Monitoring (FIXED)",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "cronExpression", "expression": "0 6 * * *" }] }
      },
      "id": "trigger",
      "name": "Daily 6AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [100, 300]
    },
    {
      "parameters": {
        "url": "https://rsshub.app/telegram/channel/YOUR_COMPETITOR_1",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "User-Agent", "value": "Mozilla/5.0 (compatible; SMM-Agent/1.0)" }] },
        "options": {
          "response": { "response": { "responseFormat": "text" } },
          "timeout": 10000
        }
      },
      "id": "competitor-1",
      "name": "Competitor Channel 1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [300, 180]
    },
    {
      "parameters": {
        "url": "https://rsshub.app/telegram/channel/YOUR_COMPETITOR_2",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "User-Agent", "value": "Mozilla/5.0 (compatible; SMM-Agent/1.0)" }] },
        "options": {
          "response": { "response": { "responseFormat": "text" } },
          "timeout": 10000
        }
      },
      "id": "competitor-2",
      "name": "Competitor Channel 2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [300, 340]
    },
    {
      "parameters": {
        "url": "https://rsshub.app/telegram/channel/YOUR_COMPETITOR_3",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "User-Agent", "value": "Mozilla/5.0 (compatible; SMM-Agent/1.0)" }] },
        "options": {
          "response": { "response": { "responseFormat": "text" } },
          "timeout": 10000
        }
      },
      "id": "competitor-3",
      "name": "Competitor Channel 3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [300, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-competitors",
      "name": "Merge Competitor Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [500, 340]
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\nconst posts = [];\n\nfor (const item of allItems) {\n  // –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π (responseFormat: text) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º\n  const body = item.json?.data || item.json?.body || '';\n  const sourceUrl = item.json?.url || '';\n  \n  if (!body) continue;\n  \n  // CDATA titles (Telegram RSS via RSSHub)\n  const cdata = [...body.matchAll(/<title><!\\[CDATA\\[([^\\]]{10,200})\\]\\]>/g)]\n    .map(m => m[1].trim());\n  \n  // –û–±—ã—á–Ω—ã–µ titles\n  const plain = [...body.matchAll(/<title>([^<]{10,150})<\\/title>/g)]\n    .map(m => m[1].trim())\n    .filter(t => !t.startsWith('http') && !t.includes('<?'));\n  \n  // Descriptions (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤)\n  const descs = [...body.matchAll(/<description><!\\[CDATA\\[([^\\]]{20,}?)\\]\\]>/g)]\n    .map(m => m[1].replace(/<[^>]+>/g, '').trim().slice(0, 200));\n  \n  const titles = [...new Set([...cdata, ...plain])].slice(0, 8);\n  \n  titles.forEach((t, i) => {\n    posts.push({ title: t, description: descs[i] || '', source: sourceUrl });\n  });\n}\n\nif (posts.length === 0) {\n  return [{ json: { noPosts: true, message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤' } }];\n}\n\nreturn [{ json: { posts: posts.slice(0, 20), count: posts.length, date: new Date().toISOString().split('T')[0] } }];"
      },
      "id": "parse-competitor-posts",
      "name": "Parse Competitor Posts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 340]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [{ "leftValue": "={{ $json.noPosts }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }]
        }
      },
      "id": "check-data",
      "name": "Has Data?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 340]
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è. –ü—Ä–æ–≤–µ—Ä—å RSSHub –∏–ª–∏ –¥–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.",
        "additionalFields": {}
      },
      "id": "notify-no-data",
      "name": "Notify No Data",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1100, 500],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "YOUR_ANTHROPIC_API_KEY" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-6\",\n  \"max_tokens\": 900,\n  \"system\": \"–¢—ã —Å—Ç—Ä–∞—Ç–µ–≥ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –¥–∞–≤–∞–π actionable –∏–Ω—Å–∞–π—Ç—ã. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ JSON –±–µ–∑ markdown.\",\n  \"messages\": [{\n    \"role\": \"user\",\n    \"content\": \"–ö–æ–Ω—Ç–µ–Ω—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ ({{ $json.count }} –ø–æ—Å—Ç–æ–≤):\\n{{ $json.posts.map(p => p.title + (p.description ? ': ' + p.description : '')).join('\\\\n---\\\\n') }}\\n\\n–û—Ç—Ä–∞—Å–ª—å: —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, B2B –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω/–°–ù–ì)\\n\\n–í–µ—Ä–Ω–∏ JSON –∞–Ω–∞–ª–∏–∑:\\n{\\n  \\\"hot_topics\\\": [\\\"—Ç–æ–ø —Ç–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ –æ—Å–≤–µ—â–∞—é—Ç\\\"],\\n  \\\"content_gaps\\\": [\\\"—á—Ç–æ –ù–ï –æ—Å–≤–µ—â–∞—é—Ç ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞—Å\\\"],\\n  \\\"best_formats\\\": [\\\"—Ñ–æ—Ä–º–∞—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç —É –Ω–∏—Ö\\\"],\\n  \\\"our_opportunities\\\": [\\\"–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–¥–µ–∏ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –Ω–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤\\\"],\\n  \\\"urgent_alert\\\": \\\"—Å—Ä–æ—á–Ω–æ–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞\\\"\\n}\\n\\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON.\"\n  }]\n}",
        "options": {}
      },
      "id": "claude-analyze",
      "name": "Claude ‚Äî Analyze",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst rawText = response.content?.[0]?.text || '{}';\nconst date = $('Parse Competitor Posts').item.json.date;\n\nlet analysis = {};\ntry {\n  const clean = rawText.replace(/```json|```/g, '').trim();\n  analysis = JSON.parse(clean);\n} catch(e) {\n  const match = rawText.match(/\\{[\\s\\S]*\\}/);\n  if (match) try { analysis = JSON.parse(match[0]); } catch(e2) { analysis = {}; }\n}\n\nreturn [{ json: { analysis, date } }];"
      },
      "id": "parse-analysis",
      "name": "Parse Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "YOUR_NOTION_KNOWLEDGE_BASE_DB_ID",
        "title": "=–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã {{ $json.date }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "Type", "type": "select", "selectValue": "–ò–Ω—Å–∞–π—Ç" },
            { "key": "Content", "type": "rich_text", "textValue": "=–ì–æ—Ä—è—á–∏–µ —Ç–µ–º—ã: {{ $json.analysis.hot_topics?.join(', ') }}\\n\\n–ü—Ä–æ–±–µ–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: {{ $json.analysis.content_gaps?.join(', ') }}\\n\\n–ù–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: {{ $json.analysis.our_opportunities?.join(', ') }}" },
            { "key": "Date", "type": "date", "dateValue": "={{ $json.date }}" }
          ]
        }
      },
      "id": "save-to-kb",
      "name": "Save to Knowledge Base",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1500, 300],
      "credentials": { "notionApi": { "id": "YOUR_NOTION_CREDENTIAL_ID", "name": "Notion API" } }
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "=üïµÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã {{ $json.date }}\n\nüî• –ì–æ—Ä—è—á–∏–µ —Ç–µ–º—ã:\n‚Ä¢ {{ $json.analysis.hot_topics?.join('\\n‚Ä¢ ') || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}\n\nüí° –ß—Ç–æ –æ–Ω–∏ –Ω–µ –æ—Å–≤–µ—â–∞—é—Ç (–Ω–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏):\n‚Ä¢ {{ $json.analysis.content_gaps?.join('\\n‚Ä¢ ') || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}\n\nüéØ –ò–¥–µ–∏ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –Ω–∞—Å:\n‚Ä¢ {{ $json.analysis.our_opportunities?.join('\\n‚Ä¢ ') || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}\n\n{{ $json.analysis.urgent_alert ? '‚ö†Ô∏è –°–†–û–ß–ù–û: ' + $json.analysis.urgent_alert : '' }}",
        "additionalFields": {}
      },
      "id": "send-insights",
      "name": "Send Insights",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1700, 300],
      "credentials": { "telegramApi": { "id": "YOUR_TELEGRAM_CREDENTIAL_ID", "name": "Telegram Bot" } }
    }
  ],
  "connections": {
    "Daily 6AM": {
      "main": [[
        { "node": "Competitor Channel 1", "type": "main", "index": 0 },
        { "node": "Competitor Channel 2", "type": "main", "index": 0 },
        { "node": "Competitor Channel 3", "type": "main", "index": 0 }
      ]]
    },
    "Competitor Channel 1": { "main": [[{ "node": "Merge Competitor Data", "type": "main", "index": 0 }]] },
    "Competitor Channel 2": { "main": [[{ "node": "Merge Competitor Data", "type": "main", "index": 1 }]] },
    "Competitor Channel 3": { "main": [[{ "node": "Merge Competitor Data", "type": "main", "index": 2 }]] },
    "Merge Competitor Data": { "main": [[{ "node": "Parse Competitor Posts", "type": "main", "index": 0 }]] },
    "Parse Competitor Posts": { "main": [[{ "node": "Has Data?", "type": "main", "index": 0 }]] },
    "Has Data?": {
      "false": [[{ "node": "Claude ‚Äî Analyze", "type": "main", "index": 0 }]],
      "true": [[{ "node": "Notify No Data", "type": "main", "index": 0 }]]
    },
    "Claude ‚Äî Analyze": { "main": [[{ "node": "Parse Analysis", "type": "main", "index": 0 }]] },
    "Parse Analysis": { "main": [[{ "node": "Save to Knowledge Base", "type": "main", "index": 0 }]] },
    "Save to Knowledge Base": { "main": [[{ "node": "Send Insights", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" }
}
